# Auto-Discovery and Generated Runners Design

**Date:** 2026-01-06
**Status:** Approved

## Overview

Redesign captain-hook to use auto-discovered hook scripts and generated bash runners for better extensibility and performance.

## Goals

1. Drop-in scripts: add a script, run `captain-hook toggle`, it appears
2. Multi-language support: Python, Node, Shell, TypeScript via shebang
3. Fast execution: generated bash runners (~5ms) instead of Python dispatcher (~50ms)
4. Simple deps: Python venv managed by captain-hook, others documented

## Directory Structure

```
~/.config/captain-hook/
├── config.json              # Enabled hooks, tracked projects
├── .venv/                   # Python dependencies venv
├── hooks/                   # Auto-discovered hooks (unified)
│   ├── post_tool_use/
│   │   ├── python-lint.py
│   │   ├── python-format.py
│   │   └── ts-format.js
│   ├── pre_tool_use/
│   │   ├── file-guard.py
│   │   ├── dangerous-cmd.sh
│   │   └── security-review.md   ← prompt hook
│   ├── stop/
│   │   ├── notify.py
│   │   └── completion-check.md  ← prompt hook
│   ├── notification/
│   │   └── notify.py
│   └── user_prompt_submit/
│       └── scope-guard.md       ← prompt hook
└── runners/                 # Generated bash runners
    ├── post_tool_use.sh
    ├── pre_tool_use.sh
    ├── stop.sh
    ├── notification.sh
    └── user_prompt_submit.sh

# Project-specific (optional)
.claude/captain-hook/
├── config.json              # Project overrides (enabled/disabled)
└── runners/                 # Project-specific runners
```

## Script Format

### Command Hooks (Python/Node/Shell)

```python
#!/usr/bin/env python3
# Description: Ruff linting for .py files
# Deps: (optional: requests, pyyaml)

import json
import sys

hook_input = json.load(sys.stdin)
file_path = hook_input.get("tool_input", {}).get("file_path", "")

# Do work...

sys.exit(0)  # 0 = ok, 2 = block
```

```javascript
#!/usr/bin/env node
// Description: Prettier formatting for JS/TS
// Deps: prettier

const input = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
// Do work...
process.exit(0);
```

```bash
#!/usr/bin/env bash
# Description: ShellCheck for shell scripts
# Deps: shellcheck

INPUT=$(cat)
FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty')
# Do work...
exit 0
```

### Prompt Hooks (Markdown)

```markdown
# Description: Verify all tasks are complete before stopping

Analyze whether the AI agent has truly completed all requested tasks.

Review the conversation context and determine:
1. Were all explicit user requests addressed?
...

Respond with JSON:
{"decision": "approve" or "block", "reason": "..."}
```

## Generated Runner Format

```bash
#!/usr/bin/env bash
# Auto-generated by captain-hook - do not edit
# Event: post_tool_use

set -euo pipefail

INPUT=$(cat)
HOOKS_DIR="$HOME/.config/captain-hook/hooks/post_tool_use"
VENV_PYTHON="$HOME/.config/captain-hook/.venv/bin/python"

# Check for project override
PROJECT_RUNNER=".claude/captain-hook/runners/post_tool_use.sh"
if [[ -f "$PROJECT_RUNNER" ]]; then
    echo "$INPUT" | "$PROJECT_RUNNER"
    exit $?
fi

# Run enabled hooks
echo "$INPUT" | "$VENV_PYTHON" "$HOOKS_DIR/python-lint.py" || exit $?
echo "$INPUT" | "$VENV_PYTHON" "$HOOKS_DIR/python-format.py" || exit $?
echo "$INPUT" | node "$HOOKS_DIR/ts-format.js" || exit $?

exit 0
```

## Config Format

```json
{
  "enabled": {
    "post_tool_use": ["python-lint", "python-format"],
    "pre_tool_use": ["file-guard", "dangerous-cmd"],
    "stop": ["notify"],
    "notification": ["notify"],
    "user_prompt_submit": []
  },
  "projects": [
    "/Users/bembu/projects/myapp",
    "/Users/bembu/work/api"
  ]
}
```

## CLI Commands

| Command | Action |
|---------|--------|
| `captain-hook` | Interactive menu (wizard on first run) |
| `captain-hook install` | Register runners in Claude settings |
| `captain-hook uninstall` | Remove from Claude, offer cleanup |
| `captain-hook toggle` | Scan hooks + enable/disable + regenerate runners |
| `captain-hook status` | Show discovered hooks + enabled state |
| `captain-hook install-deps` | Install Python deps to venv, print others |

## First-Run Wizard

```
╭─────────────────────────────────────────╮
│  Welcome to captain-hook!               │
│  Let's get you set up.                  │
╰─────────────────────────────────────────╯

? Install hooks to Claude settings? (Y/n)
? Configure which hooks to enable? (Y/n)
? Install Python dependencies? (Y/n)

╭─────────────────────────────────────────╮
│  You're all set!                        │
╰─────────────────────────────────────────╯
```

## Auto-Discovery

Scanner reads `hooks/{event}/` directories:
1. List all files with supported extensions
2. Parse second line for `# Description: ...`
3. Parse for `# Deps: ...` if present
4. Return list of discovered hooks with metadata

**Supported extensions:**
- `.py` → Python (runs with venv python)
- `.js` → Node
- `.sh` → Bash
- `.ts` → Bun/tsx
- `.md` → Prompt hook (registered in Claude as type: prompt)

## Runner Generation

On `toggle` save:
1. For each event, get list of enabled hooks
2. Generate bash runner that calls each in order
3. Write to `runners/{event}.sh`
4. Make executable

**Interpreter selection by extension:**
- `.py` → `$VENV_PYTHON script.py`
- `.js` → `node script.js`
- `.sh` → `bash script.sh`
- `.ts` → `bun run script.ts`
- `.md` → Skip (prompt hooks registered separately)

## Dependency Management

**Python:**
- Managed venv at `~/.config/captain-hook/.venv/`
- `install-deps` scans all `.py` files for `# Deps:` comments
- Installs to venv via `pip install`

**Other languages:**
- `install-deps` prints instructions:
  - Node: `npm install -g <deps>`
  - Shell: `brew install <deps>` or `apt install <deps>`

## Claude Settings Registration

Install registers generated runners:

```json
{
  "hooks": {
    "PreToolUse": [{
      "matcher": "Edit|Write|MultiEdit",
      "hooks": [{"type": "command", "command": "~/.config/captain-hook/runners/pre_tool_use.sh"}]
    }, {
      "matcher": "Bash",
      "hooks": [{"type": "command", "command": "~/.config/captain-hook/runners/pre_tool_use.sh"}]
    }],
    "PostToolUse": [{
      "matcher": "Edit|Write|MultiEdit",
      "hooks": [{"type": "command", "command": "~/.config/captain-hook/runners/post_tool_use.sh"}]
    }],
    "Stop": [{
      "hooks": [{"type": "command", "command": "~/.config/captain-hook/runners/stop.sh"}]
    }]
  }
}
```

Prompt hooks (`.md` files) registered as `type: prompt` with content.

## Performance

**Before (Python dispatcher):** ~50ms startup per hook
**After (Bash runner):** ~5ms startup per hook

~45ms saved per hook invocation.
